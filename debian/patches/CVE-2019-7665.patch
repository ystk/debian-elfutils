From de01cc6f9446187d69b9748bb3636361c79e77a4 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Wed, 16 Jan 2019 15:41:31 +0100
Subject: [PATCH] libebl: Check NT_PLATFORM core notes contain a zero
 terminated string.

Most strings in core notes are fixed size. But NT_PLATFORM contains just
a variable length string. Check that it is actually zero terminated
before passing to readelf to print.

https://sourceware.org/bugzilla/show_bug.cgi?id=24089

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 libdwfl/linux-core-attach.c |  9 +++++----
 libebl/eblcorenote.c        | 39 +++++++++++++++++++--------------------
 libebl/libebl.h             |  3 ++-
 src/readelf.c               |  2 +-
 7 files changed, 42 insertions(+), 26 deletions(-)

Index: elfutils-0.159/libdwfl/linux-core-attach.c
===================================================================
--- elfutils-0.159.orig/libdwfl/linux-core-attach.c	2019-02-18 16:09:55.124980452 +0100
+++ elfutils-0.159/libdwfl/linux-core-attach.c	2019-02-18 16:09:55.116980452 +0100
@@ -165,7 +165,7 @@
       const Ebl_Register_Location *reglocs;
       size_t nitems;
       const Ebl_Core_Item *items;
-      if (! ebl_core_note (core_arg->ebl, &nhdr, name,
+      if (! ebl_core_note (core_arg->ebl, &nhdr, name, desc,
 			   &regs_offset, &nregloc, &reglocs, &nitems, &items))
 	{
 	  /* This note may be just not recognized, skip it.  */
@@ -218,8 +218,9 @@
   const Ebl_Register_Location *reglocs;
   size_t nitems;
   const Ebl_Core_Item *items;
-  int core_note_err = ebl_core_note (core_arg->ebl, &nhdr, name, &regs_offset,
-				     &nregloc, &reglocs, &nitems, &items);
+  int core_note_err = ebl_core_note (core_arg->ebl, &nhdr, name, desc,
+				     &regs_offset, &nregloc, &reglocs,
+				     &nitems, &items);
   /* __libdwfl_attach_state_for_core already verified the note is there.  */
   assert (core_note_err != 0);
   assert (nhdr.n_type == NT_PRSTATUS);
@@ -399,7 +400,7 @@
       const Ebl_Register_Location *reglocs;
       size_t nitems;
       const Ebl_Core_Item *items;
-      if (! ebl_core_note (ebl, &nhdr, name,
+      if (! ebl_core_note (ebl, &nhdr, name, desc,
 			   &regs_offset, &nregloc, &reglocs, &nitems, &items))
 	{
 	  /* This note may be just not recognized, skip it.  */
Index: elfutils-0.159/libebl/eblcorenote.c
===================================================================
--- elfutils-0.159.orig/libebl/eblcorenote.c	2019-02-18 16:09:55.124980452 +0100
+++ elfutils-0.159/libebl/eblcorenote.c	2019-02-18 16:11:08.652979458 +0100
@@ -36,15 +36,17 @@
 #include <inttypes.h>
 #include <stdio.h>
 #include <stddef.h>
+#include <string.h>
 #include <libeblP.h>
 
 
 int
-ebl_core_note (ebl, nhdr, name,
+ebl_core_note (ebl, nhdr, name, desc,
 	       regs_offset, nregloc, reglocs, nitems, items)
      Ebl *ebl;
      const GElf_Nhdr *nhdr;
      const char *name;
+     const char *desc;
      GElf_Word *regs_offset;
      size_t *nregloc;
      const Ebl_Register_Location **reglocs;
@@ -57,28 +59,25 @@
     {
       /* The machine specific function did not know this type.  */
 
-      *regs_offset = 0;
-      *nregloc = 0;
-      *reglocs = NULL;
-      switch (nhdr->n_type)
+      /* NT_PLATFORM is kind of special since it needs a zero terminated
+         string (other notes often have a fixed size string).  */
+      static const Ebl_Core_Item platform[] =
 	{
-#define ITEMS(type, table)				\
-	  case type:					\
-	    *items = table;				\
-	    *nitems = sizeof table / sizeof table[0];	\
-	    result = 1;					\
-	    break
-
-	  static const Ebl_Core_Item platform[] =
-	    {
-	      {
-		.name = "Platform",
-		.type = ELF_T_BYTE, .count = 0, .format = 's'
-	      }
-	    };
-	  ITEMS (NT_PLATFORM, platform);
-
-#undef	ITEMS
+	  {
+	    .name = "Platform",
+	    .type = ELF_T_BYTE, .count = 0, .format = 's'
+	  }
+	};
+
+      if (nhdr->n_type == NT_PLATFORM
+	  && memchr (desc, '\0', nhdr->n_descsz) != NULL)
+        {
+	  *regs_offset = 0;
+	  *nregloc = 0;
+	  *reglocs = NULL;
+	  *items = platform;
+	  *nitems = 1;
+	  result = 1;
 	}
     }
 
Index: elfutils-0.159/libebl/libebl.h
===================================================================
--- elfutils-0.159.orig/libebl/libebl.h	2019-02-18 16:09:55.124980452 +0100
+++ elfutils-0.159/libebl/libebl.h	2019-02-18 16:09:55.116980452 +0100
@@ -377,7 +377,8 @@
 
 /* Describe the format of a core file note with the given header and NAME.
    NAME is not guaranteed terminated, it's NHDR->n_namesz raw bytes.  */
-extern int ebl_core_note (Ebl *ebl, const GElf_Nhdr *nhdr, const char *name,
+extern int ebl_core_note (Ebl *ebl, const GElf_Nhdr *nhdr,
+			  const char *name, const char *desc,
 			  GElf_Word *regs_offset, size_t *nregloc,
 			  const Ebl_Register_Location **reglocs,
 			  size_t *nitems, const Ebl_Core_Item **items)
Index: elfutils-0.159/src/readelf.c
===================================================================
--- elfutils-0.159.orig/src/readelf.c	2019-02-18 16:09:55.124980452 +0100
+++ elfutils-0.159/src/readelf.c	2019-02-18 16:09:55.120980452 +0100
@@ -8886,7 +8886,7 @@
   size_t nitems;
   const Ebl_Core_Item *items;
 
-  if (! ebl_core_note (ebl, nhdr, name,
+  if (! ebl_core_note (ebl, nhdr, name, desc,
 		       &regs_offset, &nregloc, &reglocs, &nitems, &items))
     return;
 
