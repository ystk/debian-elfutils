From 2562759d6fe5b364fe224852e64e8bda39eb2e35 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Sun, 20 Jan 2019 22:10:18 +0100
Subject: [PATCH] libdw: Check terminating NUL byte in dwarf_getsrclines for
 dir/file table.

For DWARF version < 5 the .debug_line directory and file tables consist
of a terminating NUL byte after all strings. The code used to just skip
this without checking it actually existed. This could case a spurious
read past the end of data.

Fix the same issue in readelf.

https://sourceware.org/bugzilla/show_bug.cgi?id=24102

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 libdw/dwarf_getsrclines.c | 11 ++++++++---
 src/readelf.c             |  8 ++++++--
 4 files changed, 24 insertions(+), 5 deletions(-)

Index: elfutils-0.159/libdw/dwarf_getsrclines.c
===================================================================
--- elfutils-0.159.orig/libdw/dwarf_getsrclines.c	2019-02-18 14:49:54.069045334 +0100
+++ elfutils-0.159/libdw/dwarf_getsrclines.c	2019-02-18 15:01:12.753036162 +0100
@@ -204,7 +204,7 @@
       unsigned int ndirlist = 1;
 
       // XXX Directly construct array to conserve memory?
-      while (*linep != 0)
+      while (linep < lineendp && *linep != '\0')
 	{
 	  struct dirlist *new_dir =
 	    (struct dirlist *) alloca (sizeof (*new_dir));
@@ -219,6 +219,9 @@
 	  ++ndirlist;
 	  linep = endp + 1;
 	}
+      if (linep >= lineendp || *linep != '\0')
+       goto invalid_data;
+
       /* Skip the final NUL byte.  */
       ++linep;
 
@@ -244,7 +247,7 @@
 
       if (unlikely (linep >= lineendp))
 	goto invalid_data;
-      while (*linep != 0)
+      while (linep < lineendp && *linep != '\0')
 	{
 	  struct filelist *new_file =
 	    (struct filelist *) alloca (sizeof (*new_file));
@@ -300,6 +303,8 @@
 	  filelist = new_file;
 	  ++nfilelist;
 	}
+      if (linep >= lineendp || *linep != '\0')
+	goto invalid_data;
       /* Skip the final NUL byte.  */
       ++linep;
 
Index: elfutils-0.159/src/readelf.c
===================================================================
--- elfutils-0.159.orig/src/readelf.c	2019-02-18 14:49:54.069045334 +0100
+++ elfutils-0.159/src/readelf.c	2019-02-18 15:04:46.365033275 +0100
@@ -6259,7 +6259,7 @@
 	goto invalid_unit;
 
       puts (gettext ("\nDirectory table:"));
-      while (*linep != 0)
+      while (linep < lineendp && *linep != 0)
 	{
 	  unsigned char *endp = memchr (linep, '\0', lineendp - linep);
 	  if (unlikely (endp == NULL))
@@ -6269,6 +6269,8 @@
 
 	  linep = endp + 1;
 	}
+      if (linep >= lineendp || *linep != 0)
+        goto invalid_unit;
       /* Skip the final NUL byte.  */
       ++linep;
 
@@ -6276,7 +6278,7 @@
 	goto invalid_unit;
       puts (gettext ("\nFile name table:\n"
 		     " Entry Dir   Time      Size      Name"));
-      for (unsigned int cnt = 1; *linep != 0; ++cnt)
+      for (unsigned int cnt = 1; linep < lineendp && *linep != 0; ++cnt)
 	{
 	  /* First comes the file name.  */
 	  char *fname = (char *) linep;
@@ -6300,6 +6302,8 @@
 	  printf (" %-5u %-5u %-9u %-9u %s\n",
 		  cnt, diridx, mtime, fsize, fname);
 	}
+      if (linep >= lineendp || *linep != '\0')
+        goto invalid_unit;
       /* Skip the final NUL byte.  */
       ++linep;
 
