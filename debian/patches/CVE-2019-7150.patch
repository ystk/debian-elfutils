From da5c5336a1eaf519de246f7d9f0f5585e1d4ac59 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Sun, 20 Jan 2019 23:05:56 +0100
Subject: [PATCH] libdwfl: Sanity check partial core file dyn data read.

When reading the dyn data from the core file check if we got everything,
or just part of the data.

https://sourceware.org/bugzilla/show_bug.cgi?id=24103

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 libdwfl/dwfl_segment_report_module.c | 6 ++++++
 2 files changed, 11 insertions(+)

Index: elfutils-0.159/libdwfl/dwfl_segment_report_module.c
===================================================================
--- elfutils-0.159.orig/libdwfl/dwfl_segment_report_module.c	2019-02-18 15:10:10.761028892 +0100
+++ elfutils-0.159/libdwfl/dwfl_segment_report_module.c	2019-02-18 15:15:38.061024468 +0100
@@ -575,6 +575,12 @@
   if (dyn_filesz != 0 && dyn_filesz % dyn_entsize == 0
       && ! read_portion (&dyn_data, &dyn_data_size, dyn_vaddr, dyn_filesz))
     {
+     /* dyn_data_size will be zero if we got everything from the initial
+        buffer, otherwise it will be the size of the new buffer that
+        could be read.  */
+     if (dyn_data_size != 0)
+	dyn_filesz = dyn_data_size;
+
       union
       {
 	Elf32_Dyn d32[dyn_filesz / sizeof (Elf32_Dyn)];
